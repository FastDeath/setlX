#!/bin/bash

resultFile=$(mktemp)
timeFile=$(mktemp)

cd src;

time (
    # loop through all SetlX files, execute them and compare to reference result
    while read -r -d $'\0' path
      do
        filename="${path#example_SetlX_code/}"

        echo "executing file '$filename' ..."

        time (
            # execute with setlX
            ./setlX --predictableRandom "$path" > "$resultFile"
        ) 2> "$timeFile"

        cat "$timeFile"

        diff "$path.reference" "$timeFile" > /dev/null
        if [ $? -eq 1 ]
          then
            echo "executing file '$filename' failed!"
            exit 1
        fi

        echo

    done < <( find -L "../example_SetlX_code/performance_test_code" -name "*.stlx" -print0 )
) 2> "$timeFile"

cd ..

echo "overall time:"

cat "$timeFile"
echo

rm -f "$tmpFile" "$timeFile"

exit 0

